var rtc={firefox:!1},rtcLoginParams={};!function(a,n,c){rtc.init=function(o){rtc.firefox=-1<navigator.userAgent.toLowerCase().indexOf("firefox"),rtcConfig=o,rtc.shim()},rtc.hasRTCPeerConnection=function(){return n.RTCPeerConnection=n.RTCPeerConnection||n.webkitRTCPeerConnection||n.mozRTCPeerConnection,!!n.RTCPeerConnection},rtc.shim=function(){rtc.hasRTCPeerConnection()?"addStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.addStream=function(e){var t=this;e.getTracks().forEach(function(o){t.addTrack(o,e)})}):console.log("Sorry, your browser does not support WebRTC.")},rtc._socketTimer=0,rtc._socket=null,rtc._events={},rtc.on=function(o,e){rtc._events[o]=rtc._events[o]||[],rtc._events[o].push(e)},rtc.fire=function(o,e){rtc.debug("fired ["+o+"]");var t=rtc._events[o],n=Array.prototype.slice.call(arguments,1);if(t)for(var c=0,r=t.length;c<r;c++)t[c].apply(null,n)},rtc.connections={},rtc.connectionsLoaded=!1,rtc.id=null,rtc.compatible=!0,rtc.connectionId=null,rtc.userData={},rtc.roomOptions={},rtc.usersCount=0,rtc.debug=function(o){rtcConfig.debug&&console.log(o)},rtc.checkCompatibility=function(o,e,t){return t=t||"call",rtc.compatible=!0,n.WebSocket||(o.websocket=!0,rtc.compatible=!1),n.RTCPeerConnection||n.PeerConnection||("call"==t?(o.peerconnection=!0,rtc.compatible=!1):e.peerconnection=!0),rtc.compatible},rtc.loadDevices=function(e){var t={audio:[],video:[]};navigator&&navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(o){o.forEach(function(o){"videoinput"===o.kind?t.video.push({value:o.deviceId,text:o.label}):"audioinput"===o.kind&&t.audio.push({value:o.deviceId,text:o.label})}),e(t)}):e(t)},rtc.connect=function(o){rtc._socket=new WebSocket(o),rtc._socket.onopen=function(){rtc.fire("connected"),rtc._socketTimer&&(n.clearInterval(rtc._socketTimer),rtc._socketTimer=0,a("#chatboxes_wide").find("textarea").prop("disabled",!1))},rtc._socket.onmessage=function(o){o=JSON.parse(o.data);rtc.debug("RECEIVED MESSAGE "+o.type),rtc.debug(o),rtc.fire(o.type,o.data)},rtc._socket.onerror=function(o){rtc.debug("onerror"),rtc.debug(o),rtc.fire("socket_error",o)},rtc._socket.onclose=function(o){rtc._socketTimer||(a("#chatboxes_wide").find("textarea").prop("disabled",!0),rtc._socketTimer=setInterval(function(){rtc.connect(rtcConfig.wsURL)},2e4)),rtc.fire("socket_closed",{})}},rtc.on("connections",function(o){rtc.connections=o,rtc.connectionsLoaded=!0}),rtc.on("connectionId",function(o){rtc.connectionId=o.connectionId,rtc.userData=o.data.data.userData,rtc.usersCount=o.users_count,rtc.roomOptions=o.room,rtc.roomOptions.desktopShare=!1}),rtc.on("connectionId",function(o){rtc.id=o.connectionId,rtc.fire("logged",o.data)}),rtc.on("connection_add",function(o){rtc.id!=o.connectionId&&(rtc.connections[o.connectionId]=o.data)}),rtc.on("connection_remove",function(o){delete rtc.connections[o.connectionId]}),rtc.send=function(o){rtc.debug("SENDING MSG "+o.type),rtc.debug(o),rtc._socket.send(JSON.stringify(o))},rtc.login=function(o){rtc.send({type:"login",data:o})},rtc.apiSendOneUser=function(o,e){rtc.send({type:"api_send_one_user",connectionId:o,data:e})},rtc.apiSendAllUser=function(o){rtc.send({type:"api_send_all_user",data:o})},rtc.onConnectionClose=function(o){delete rtc.connections[o]},a.fn.mgRtc=function(o){return rtc.init(o),rtc},a.fn.loadRtc=function(e){var t=this,o={},n={},c={websocket:"Your browser does not support websocket.",peerconnection:"Your browser does not support PeerConnections.",usermedia:"Your browser does not support user media."};if(e.checkCompatibility(o,n,"chat")){if(e.loadDevices(function(o){t.devices=o,rtcLoginParams.hasAudioDevice=0<t.devices.audio.length,rtcLoginParams.hasVideoDevice=0<t.devices.video.length}),!a.isEmptyObject(n)){i=[];for(r in n)i.push(c[r]);i.push("You will not be able to make video calls."),i.push('Please try <a href="http://www.google.com/chrome" target="_blank">Google Chrome</a> or <a href="http://www.mozilla.org/en-US/firefox" target="_blank">Mozilla Firefox</a>'),console.log(i.join("<br>"))}n.peerconnection&&(rtcLoginParams.noPc=!0),n.usermedia&&(rtcLoginParams.noMedia=!0),e.connect(rtcConfig.wsURL)}else{t.debug(o);var r,i=[];for(r in o)i.push(c[r]);i.push(t._('Please try <a href="http://www.google.com/chrome" target="_blank">Google Chrome</a> or <a href="http://www.mozilla.org/en-US/firefox" target="_blank">Mozilla Firefox</a>')),console.log(i.join("<br>"))}e.on("connected",function(){e.login(rtcLoginParams)}),e.on("connection_remove",function(o){e.onConnectionClose(o.connectionId)}),e.on("socket_error",function(o){console.log("Error connecting to media server: "+o.name+" "+o.message)}),e.on("socket_closed",function(o){console.log("Websocket closed, please try reloading page later.")}),e.on("stream_error",function(o){console.log("Error getting local media stream: "+t.getErrorText(o))}),e.on("pc_error",function(o){console.log("Error creating peer connection: "+o.name+" "+o.message)}),e.on("message",function(o){console.log(o.text,o.type)}),rtcConfig.enableNotifications&&notificationsHelper.grant()},a.fn.mgNotifications=function(o){return{grant:function(e){if(this.checkActive())return!0;n.Notification.requestPermission(function(o){e&&e(o)})},checkActive:function(){return"Notification"in n&&("granted"===n.Notification.permission||"denied"!==n.Notification.permission&&void 0)},notify:function(o,e,t){if(!this.checkActive())return!1;c.hidden&&(new Notification(o,e).onclick=function(o){o.preventDefault(),n.focus(),this.close()})}}}}(jQuery,window,document);var wsDomain=document.domain,wsPort="",wsProtocol="ws",wsPath="/wsapp/";"https:"==window.location.protocol&&(wsProtocol="wss",window.location.port,wsPort=window.location.port);var wsUrl=wsProtocol+"://"+wsDomain+wsPort+wsPath,rtcConfig={wsURL:wsUrl+"?room=10&userid="+uid,debug:!1,login:null,enableNotifications:!0};(rtc=$.fn.mgRtc(rtcConfig)).init(rtcConfig);var notificationsHelper=$.fn.mgNotifications(rtc);$.fn.loadRtc(rtc);